# Import libraries
library(readxl)   
library(mice)     
library(openxlsx)  

# Set seed for reproducibility
set.seed(123)


# Import data from Excel file
data <- read_excel("D:/DatasetTBI.xlsx")

# Optional dry run (maxit = 0) and statistics on the data
imp <- mice(data, maxit = 0)
# Optional: Customize predictorMatrix if needed
# pred <- imp$predictorMatrix  # Not used here, but available for customization

# Specify the imputation methods for numerical features
meth <- imp$meth

# Set imputation methods for features with missing values
meth[c("AMR", "BR", "CR", "SSA")] <- "CART"  # Impute these features
meth[c("Percentage", "Interlayer", "Cation", "Anion", "Molarity", "PW", "CD")] <- ""  
meth["Capacitance"] <- ""  # Do not impute output

# Perform imputation with 3 datasets
imp <- mice(data, maxit = 20, m = 3, method = meth)

# Robust function to ensure values are divisible by 5
adjust_divisible_by_5 <- function(x) {
  x <- as.numeric(x)
  ifelse(is.na(x), NA, ifelse(x %% 5 == 0, x, round(x / 5) * 5))
}

# Save each of the 3 imputed datasets
for (i in 1:3) {
  # Extract the imputed dataset
  imputed_i <- complete(imp, i)
  
  # Apply divisibility adjustment
  imputed_i$AMR <- adjust_divisible_by_5(imputed_i$AMR)
  imputed_i$BR <- adjust_divisible_by_5(imputed_i$BR)
  imputed_i$CR <- adjust_divisible_by_5(imputed_i$CR)
  
  # Save the dataset
  write.xlsx(imputed_i, paste0("D:/DatasetI", i, ".xlsx"))
  
  # Optional: print summary
  cat("\nSummary for DatasetI", i, ":\n", sep = "")
  print(summary(imputed_i))
}
